<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OPML ARK Viewer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
      }
      #treePane {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      #treeHeader {
        padding: 10px;
        border-bottom: 1px solid #ccc;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      #tree {
        flex: 1;
        overflow: auto;
        padding: 10px;
        user-select: none;
      }
      #controls {
        width: 300px;
        border-left: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        overflow: auto;
      }
      #preview h1, #preview h2, #preview h3, #preview div {
        margin: 4px 0;
      }
      #sortMenu {
        position: absolute;
        background: #fff;
        border: 1px solid #ccc;
        list-style: none;
        margin: 0;
        padding: 4px;
        display: none;
      }
      #sortMenu li {
        padding: 4px 8px;
        cursor: pointer;
      }
      #sortMenu li:hover {
        background: #eee;
      }
      .selected {
        background: #ffd966;
      }
      li {
        cursor: pointer;
        user-select: none;
      }
      li.collapsed > ul {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="treePane">
      <div id="treeHeader">
        <input type="file" id="fileInput" />
        <div id="sortWrapper" style="position:relative;">
          <button id="sortBtn">Sort</button>
          <ul id="sortMenu">
            <li data-sort="az">Name A-Z</li>
            <li data-sort="za">Name Z-A</li>
            <li data-sort="mod">Modified ⬇</li>
            <li data-sort="omod">Modified ⬆</li>
          </ul>
        </div>
        <div id="saveIndicator" style="margin-left:auto;font-size:12px;color:#555"></div>
      </div>
      <div id="tree"></div>
    </div>
    <div id="controls">
      <button id="addChild">Add Child</button>
      <button id="addSibling">Add Sibling</button><br /><br />
      <button id="expandAll">Expand All</button>
      <button id="collapseAll">Collapse All</button><br /><br />
      <button id="save">Save OPML</button>
      <h3>Preview</h3>
      <div id="preview"></div>
    </div>
    <script>
      let opmlDoc = null;
      let selectedLi = null;
      let sortCriteria = "az";

      document.getElementById("fileInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const parser = new DOMParser();
          opmlDoc = parser.parseFromString(reader.result, "text/xml");
          saveState();
          renderTree();
          renderPreview();
        };
        reader.readAsText(file);
      });

      function outlineToJson(node) {
        const obj = {
          id: node.getAttribute("id") || crypto.randomUUID(),
          title: node.getAttribute("text") || "",
          content: node.getAttribute("_note") || "",
          modified: parseInt(node.getAttribute("_modified")) || Date.now(),
          children: [],
        };
        Array.from(node.children).forEach((c) => {
          if (c.nodeName === "outline") obj.children.push(outlineToJson(c));
        });
        return obj;
      }

      function stateFromDom() {
        if (!opmlDoc) return null;
        const title = opmlDoc.querySelector("head > title")?.textContent || "Untitled";
        const body = opmlDoc.querySelector("body");
        const root = [];
        body.childNodes.forEach((n) => {
          if (n.nodeName === "outline") root.push(outlineToJson(n));
        });
        return { metadata: { title }, root };
      }

      function saveState() {
        if (!opmlDoc) return;
        const indicator = document.getElementById("saveIndicator");
        indicator.textContent = "Saving...";
        fetch("save_to_cloud.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(stateFromDom()),
        })
          .then(() => {
            indicator.textContent = "✓";
            setTimeout(() => (indicator.textContent = ""), 1000);
          })
          .catch(() => {
            indicator.textContent = "Save failed";
          });
      }

      function renderTree() {
        const body = opmlDoc.querySelector("body");
        const treeDiv = document.getElementById("tree");
        treeDiv.innerHTML = "";
        const ul = document.createElement("ul");
        body.childNodes.forEach((node) => {
          if (node.nodeName === "outline") ul.appendChild(makeLi(node));
        });
        treeDiv.appendChild(ul);
      }

      function makeLi(outline) {
        const li = document.createElement("li");
        li.textContent = outline.getAttribute("text") || "Untitled";
        li.dataset.path = getXPath(outline);
        li.onclick = (e) => {
          e.stopPropagation();
          if (selectedLi) selectedLi.classList.remove("selected");
          selectedLi = li;
          li.classList.add("selected");
        };
        li.ondblclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          li.classList.toggle("collapsed");
        };
        const children = outline.children;
        if (children.length) {
          const ul = document.createElement("ul");
          [...children].forEach((c) => {
            ul.appendChild(makeLi(c));
          });
          li.appendChild(ul);
        }
        return li;
      }

      function getXPath(node) {
        if (node.nodeName === "body") return "/body";
        const index = [...node.parentNode.children].indexOf(node) + 1;
        return getXPath(node.parentNode) + `/outline[${index}]`;
      }

      function findOutline(path) {
        return opmlDoc.evaluate(
          path,
          opmlDoc,
          null,
          XPathResult.FIRST_ORDERED_NODE_TYPE,
          null,
        ).singleNodeValue;
      }

      function renderPreview() {
        const preview = document.getElementById("preview");
        preview.innerHTML = "";
        if (!opmlDoc) return;
        const body = opmlDoc.querySelector("body");

        function walk(node, level) {
          const wrap = document.createElement("div");
          const heading = document.createElement(level === 0 ? "h2" : "h3");
          heading.textContent = node.getAttribute("text") || "Untitled";
          heading.onclick = () => {
            const inp = document.createElement("input");
            inp.value = heading.textContent;
            inp.onblur = () => {
              node.setAttribute("text", inp.value);
              node.setAttribute("_modified", Date.now());
              saveState();
              renderTree();
              renderPreview();
            };
            inp.onkeydown = (e) => {
              if (e.key === "Enter") inp.blur();
            };
            heading.replaceWith(inp);
            inp.focus();
          };
          wrap.appendChild(heading);

          const noteText = node.getAttribute("_note") || "";
          const content = document.createElement("div");
          content.innerHTML = noteText.replace(/\n/g, "<br>");
          content.onclick = () => {
            const ta = document.createElement("textarea");
            ta.value = noteText;
            ta.onblur = () => {
              if (ta.value) node.setAttribute("_note", ta.value);
              else node.removeAttribute("_note");
              node.setAttribute("_modified", Date.now());
              saveState();
              renderTree();
              renderPreview();
            };
            content.replaceWith(ta);
            ta.focus();
          };
          wrap.appendChild(content);

          Array.from(node.children).forEach((c) => {
            if (c.nodeName === "outline") wrap.appendChild(walk(c, level + 1));
          });
          return wrap;
        }

        body.childNodes.forEach((n) => {
          if (n.nodeName === "outline") preview.appendChild(walk(n, 0));
        });
      }

      function promptNode() {
        const text = prompt("Node title?");
        if (text === null) return null;
        const note = prompt("Note (optional)?");
        const el = opmlDoc.createElement("outline");
        el.setAttribute("text", text || "Untitled");
        if (note) el.setAttribute("_note", note);
        el.setAttribute("_modified", Date.now());
        return el;
      }

      function addChild() {
        if (!selectedLi) {
          alert("Select a node first");
          return;
        }
        const outline = findOutline(selectedLi.dataset.path);
        const newNode = promptNode();
        if (!newNode) return;
        outline.appendChild(newNode);
        saveState();
        sortTree();
      }

      function addSibling() {
        if (!selectedLi) {
          alert("Select a node first");
          return;
        }
        const outline = findOutline(selectedLi.dataset.path);
        const parent = outline.parentNode;
        const newNode = promptNode();
        if (!newNode) return;
        parent.insertBefore(newNode, outline.nextSibling);
        saveState();
        sortTree();
      }

      function expandCollapseAll(expand) {
        document.querySelectorAll("#tree li").forEach((li) => {
          if (expand) li.classList.remove("collapsed");
          else li.classList.add("collapsed");
        });
      }

      function save() {
        const serializer = new XMLSerializer();
        const text = serializer.serializeToString(opmlDoc);
        const blob = new Blob([text], { type: "text/xml" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "output.opml";
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function sortOutlines(node) {
        const children = Array.from(node.children).filter(
          (c) => c.nodeName === "outline",
        );
        children.sort((a, b) => {
          if (sortCriteria === "az")
            return (a.getAttribute("text") || "").localeCompare(
              b.getAttribute("text") || "",
            );
          if (sortCriteria === "za")
            return (b.getAttribute("text") || "").localeCompare(
              a.getAttribute("text") || "",
            );
          if (sortCriteria === "mod")
            return (
              (b.getAttribute("_modified") || 0) -
              (a.getAttribute("_modified") || 0)
            );
          if (sortCriteria === "omod")
            return (
              (a.getAttribute("_modified") || 0) -
              (b.getAttribute("_modified") || 0)
            );
          return 0;
        });
        children.forEach((c) => node.appendChild(c));
        children.forEach((c) => sortOutlines(c));
      }

      function sortTree() {
        if (!opmlDoc) return;
        const body = opmlDoc.querySelector("body");
        sortOutlines(body);
        renderTree();
        renderPreview();
        saveState();
      }

      document.getElementById("addChild").onclick = addChild;
      document.getElementById("addSibling").onclick = addSibling;
      document.getElementById("expandAll").onclick = () => expandCollapseAll(true);
      document.getElementById("collapseAll").onclick = () => expandCollapseAll(false);
      document.getElementById("save").onclick = save;
      document.getElementById("sortBtn").onclick = () => {
        const menu = document.getElementById("sortMenu");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
      };
      document.querySelectorAll("#sortMenu li").forEach((li) => {
        li.onclick = () => {
          sortCriteria = li.dataset.sort;
          document.getElementById("sortMenu").style.display = "none";
          sortTree();
        };
      });

      renderPreview();
    </script>
  </body>
</html>
